<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Pictionary: Play with a robot against your friends!</title>
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
</head>
<body style="font-family: Helvetica;">
				

	<section id="home">
		<div class="container">
				<form class="form-group" id="azure-setup" style="position: absolute; bottom: 8px; right: 8px">
					<input id="speechSubscriptionKey" type="hidden" value="ae41fa8eeb1a413baaeac3b80ed9bf18" placeholder="Speech Recognition Key" class="form-control">
					<input id="speakerSubscriptionKey" type="hidden" value="47a317206894400489d697698fdde1c4" placeholder="Speaker Recognition Key" class="form-control">
					<input id="regionKey" type="hidden" value="westus" placeholder="Region" class="form-control">
					<a href="#home" style="width: auto;" class="btn btn-primary form-control" onclick="setup()">Setup Azure</a>
				</form>
			<h2>Welcome to PictRNNary!</h2>
			<h2>Would you like to play by yourself?</h2>
			<a onclick="singlePlay()" class="btn btn-primary">Yes</a>
			<a href="#enroll" class="btn btn-success">No</a>
		</div>
	</section>
	<a id="link-to-canvas" href="#canvas" style="display:none"></a>

	<section id="enroll">
		<div class="container">
			<h2>Add a person</h2>
			<div id="players"></div>
			<a class="btn btn-info" onclick="enrollNewProfile(10)">Add another player (up to 10)</a>
			<a class="btn btn-primary" onclick="play()">Play!</a>
		</div>
	</section>

	<section id="play">
		<!-- aaron -->
		<div class="container" style="">
			<div id="canvas" style="">
			</div>
			<button class="btn btn-danger" onclick="giveUp()">Give up?</button>
		</div>
	</section>

	<section id="end">
		<div class="container">
			<h2>Play again?</h2>
			<a href="#play" class="btn btn-primary" onclick="play()">Yes</a>
			<a href="#home" class="btn btn-danger" onclick="removePlayers()">No</a><!-- oh no this will erase your enrollment profiles! -->
		</div>
	</section>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vivus/0.4.4/vivus.min.js"></script>
	<script src="./jquery.min.js"></script>
	<script src="./recorder.js"></script>
	<script src="./toaster.js"></script>
	<script src="./microsoft.cognitiveservices.speech.sdk.bundle.js"></script>
	<script src="./voice.js"></script>
	<script>
		let azureState = "not setup"

		function setup(){
			azureState = "setup";
			// $('#setup-button')
			$.toaster({message: "Successfully connected to Azure", priority: "success"})
		}
		// Speaker Recognition API profile configuration - constructs to make management easier
		var Profile = class { constructor (name, profileId) { this.name = name; this.profileId = profileId;this.score=0}};
		var VerificationProfile = class { constructor (name, profileId) { this.name = name; this.profileId = profileId; this.remainingEnrollments = 3}};
		var profileIds = [];
		var verificationProfile = new VerificationProfile();
		var lastSpoke = undefined;
		var correct = false;

		function singlePlay(){
			azureState = "registered"
			play()
		}
		function play(){
			if(azureState !== "registered"){
				$.toaster({message: "Please register more players first", priority: "danger"})
				return
			}
			location.href = '#canvas'
			var obj = 'sheep'
			$('#azure-setup').css('display', 'none')
			new Vivus('working-canvas',
				{duration: 1000, type:'oneByOne', pathTimingFunction: Vivus.EASE})


			var recognizeSpeechId = setInterval(function(){
				recognizer.recognizeOnceAsync(
				function (result) {
					window.console.log(result);

					if(result.privText.toLowerCase().indexOf(obj) > 0){
						correct = true;
						clearInterval(recognizeSpeechId);
					}

					recognizer.close(); 
					recognizer = undefined;
				},
				function (err) {
					window.console.log(err);

					recognizer.close();
					recognizer = undefined;
				})
			}, 250);

			var recognizeSpeakerId = setTimeout(function(){
				if(correct)
					clearInterval(recognizeSpeakerId);
				startListeningForIdentification();
			}, 250);
		}


		function nextImage(){
			console.log('test')
			$.get('/bad2.svg', function(res){

				let response = res
				$('#canvas').html(response)
				svg = $('svg')[0]
				svg.setAttribute('id', 'working-canvas')
				document.getElementById("working-canvas").setAttribute('height', '100%')
				document.getElementById("working-canvas").setAttribute('width', '100%')
				document.getElementById("working-canvas").setAttribute("viewBox", "20 10 50 50");
				new Vivus('working-canvas',
                    {duration: 888, type:'oneByOne', start:'autostart', pathTimingFunction: Vivus.EASE})
			}, 'text')
			.fail(function(){
				alert("Error receiving drawing.")
			})
		}
		var recorder;
		var audio_context;

		function onMediaSuccess(stream, callback, secondsOfAudio) {
			audio_context = audio_context || new window.AudioContext;
			var input = audio_context.createMediaStreamSource(stream);
			recorder = new Recorder(input);
			recorder.record();
				
			setTimeout(() => { StopListening(callback); }, secondsOfAudio*1000);
		}

		function onMediaError(e) {
				console.error('media error', e);
		}

		function StopListening(callback){
			console.log('...working...');
			recorder && recorder.stop();
			recorder.exportWAV(function(blob) {
					callback(blob);
			});
			recorder.clear();
		}
	
	</script>
	<script src="./speaker-recognition-api-demo-core.js"></script>
</body>
</html>
